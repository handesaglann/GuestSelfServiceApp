<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoices</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">
  <h2>My Invoices</h2>

  <!-- Toplam Harcama -->
  <div class="alert alert-info">
    <strong>Total Spent: </strong> <span id="totalSpent">0</span> ₺
  </div>

  <!-- Fatura Tablosu -->
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Amount</th>
        <th>Currency</th>
        <th>Issued At</th>
        <th>Paid</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody id="invoiceBody"></tbody>
  </table>

  <!-- CSV Yükleme (Admin/Test için) -->
  <h3 class="mt-5">Upload Invoices (CSV)</h3>
  <form id="uploadForm" enctype="multipart/form-data">
    <div class="mb-3">
      <input type="file" name="file" id="file" class="form-control">
    </div>
    <button type="submit" class="btn btn-primary">Upload</button>
  </form>

  <script>
    // Faturaları listele
    function loadInvoices() {
      fetch("/invoices")
        .then(res => res.json())
        .then(invoices => {
          const tbody = document.getElementById("invoiceBody");
          tbody.innerHTML = "";
          invoices.forEach(inv => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${inv.total_amount}</td>
              <td>${inv.currency}</td>
              <td>${inv.issued_at}</td>
              <td>${inv.paid ? "Yes" : "No"}</td>
              <td>${inv.source}</td>
            `;
            tbody.appendChild(row);
          });
        });
    }

    // CSV yükleme
    document.getElementById("uploadForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData();
      const fileField = document.getElementById("file");
      formData.append("file", fileField.files[0]);

      fetch("/upload_invoices", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        alert("CSV uploaded: " + JSON.stringify(data));
        loadInvoices();
        loadTotalSpent();
      });
    });

    // Toplam harcama yükle
    function loadTotalSpent() {
      fetch("/my-total")
        .then(res => res.json())
        .then(data => {
          document.getElementById("totalSpent").innerText = data.total_spent;
        });
    }

    // Sayfa açılınca faturaları + toplamı yükle
    loadInvoices();
    loadTotalSpent();
  </script>
</body>
</html>
